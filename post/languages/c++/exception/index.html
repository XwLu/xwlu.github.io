<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <script type="application/javascript" src='https://xwlu.github.io/js/theme-mode.js'></script>
    <link rel="stylesheet" href='https://xwlu.github.io/css/frameworks.min.css' />
    <link rel="stylesheet" href='https://xwlu.github.io/css/github.min.css' />
    <link rel="stylesheet" href='https://xwlu.github.io/css/github-style.css' />
    <link rel="stylesheet" href='https://xwlu.github.io/css/light.css' />
    <link rel="stylesheet" href='https://xwlu.github.io/css/dark.css' />
    <link rel="stylesheet" href='https://xwlu.github.io/css/syntax.css' />
    <title>Exception - 朝花夕拾</title>
    
    <link rel="icon" type="image/x-icon" href='/images/github.png'>
    
    <meta name="theme-color" content="#1e2327">

    <link rel="stylesheet" href="https://xwlu.github.io/css/custom.css">
    <script type="text/javascript" src="https://xwlu.github.io/js/custom.js"></script>

    
    <meta name="description"
  content="Exception for C&#43;&#43;" />
<meta name="keywords"
  content='blog, robotics' />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://xwlu.github.io/post/languages/c&#43;&#43;/exception/" />


<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="Exception - 朝花夕拾" />
<meta name="twitter:description"
  content="Exception for C&#43;&#43;" />
<meta name="twitter:site" content="https://xwlu.github.io/" />
<meta name="twitter:creator" content="" />
<meta name="twitter:image"
  content="https://xwlu.github.io/">


<meta property="og:type" content="article" />
<meta property="og:title" content="Exception - 朝花夕拾">
<meta property="og:description"
  content="Exception for C&#43;&#43;" />
<meta property="og:url" content="https://xwlu.github.io/post/languages/c&#43;&#43;/exception/" />
<meta property="og:site_name" content="Exception" />
<meta property="og:image"
  content="https://xwlu.github.io/">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">

<meta property="article:published_time" content="2025-04-02 10:32:39 &#43;0800 CST" />











</head>


<body>
  <div style="position: relative">
  <header class="Header js-details-container Details px-3 px-md-4 px-lg-5 flex-wrap flex-md-nowrap open Details--on">
    <div class="Header-item mobile-none" style="margin-top: -4px; margin-bottom: -4px;">
      <a class="Header-link" href="https://xwlu.github.io/">
        <img class="octicon" height="32" width="32" src="/images/github-mark-white.png">
      </a>
    </div>
    <div class="Header-item d-md-none">
      <button class="Header-link btn-link js-details-target" type="button"
        onclick="document.querySelector('#header-search').style.display = document.querySelector('#header-search').style.display == 'none'? 'block': 'none'">
        <svg height="24" class="octicon octicon-three-bars" viewBox="0 0 16 16" version="1.1" width="24">
          <path fill-rule="evenodd" d="M1 2.75A.75.75 0 011.75 2h12.5a.75.75 0 110 1.5H1.75A.75.75 0 011 2.75zm0 5A.75.75 0 011.75 7h12.5a.75.75 0 110 1.5H1.75A.75.75 0 011 7.75zM1.75 12a.75.75 0 100 1.5h12.5a.75.75 0 100-1.5H1.75z">
          </path>
        </svg>
      </button>
    </div>
    <div style="display: none;" id="header-search"
      class="Header-item Header-item--full flex-column flex-md-row width-full flex-order-2 flex-md-order-none mr-0 mr-md-3 mt-3 mt-md-0 Details-content--hidden-not-important d-md-flex">
      <div
        class="Header-search header-search flex-auto js-site-search position-relative flex-self-stretch flex-md-self-auto mb-3 mb-md-0 mr-0 mr-md-3 scoped-search site-scoped-search js-jump-to">
        <div class="position-relative">
          
          <form target="_blank" action="https://www.google.com/search" accept-charset="UTF-8" method="get"
            autocomplete="off">
            <label
              class="Header-search-label form-control input-sm header-search-wrapper p-0 js-chromeless-input-container header-search-wrapper-jump-to position-relative d-flex flex-justify-between flex-items-center">
              <input type="text"
                class="Header-search-input form-control input-sm header-search-input jump-to-field js-jump-to-field js-site-search-focus js-site-search-field is-clearable"
                name="q" value="" placeholder="Search" autocomplete="off">
              <input type="hidden" name="q" value="site:https://xwlu.github.io/">
            </label>
          </form>
          
        </div>
      </div>
    </div>

    <div class="Header-item Header-item--full flex-justify-center d-md-none position-relative">
      <a class="Header-link " href="https://xwlu.github.io/">
        <img class="octicon octicon-mark-github v-align-middle" height="32" width="32" src="/images/github-mark-white.png">
      </a>
    </div>
    <div class="Header-item" style="margin-right: 0;">
      <a href="javascript:void(0)" class="Header-link no-select" onclick="switchTheme()">
        <svg style="fill: var(--color-profile-color-modes-toggle-moon);" class="no-select" viewBox="0 0 16 16"
          version="1.1" width="16" height="16">
          <path fill-rule="evenodd" clip-rule="evenodd"
            d="M4.52208 7.71754C7.5782 7.71754 10.0557 5.24006 10.0557 2.18394C10.0557 1.93498 10.0392 1.68986 10.0074 1.44961C9.95801 1.07727 10.3495 0.771159 10.6474 0.99992C12.1153 2.12716 13.0615 3.89999 13.0615 5.89383C13.0615 9.29958 10.3006 12.0605 6.89485 12.0605C3.95334 12.0605 1.49286 10.001 0.876728 7.24527C0.794841 6.87902 1.23668 6.65289 1.55321 6.85451C2.41106 7.40095 3.4296 7.71754 4.52208 7.71754Z">
          </path>
        </svg>
      </a>
    </div>
  </header>
</div>

  <div id="search-result" class="container-lg px-3 new-discussion-timeline" style="display: none;">
</div>

  
<div class="application-main">
  <div>
  <main>
    <div class="gisthead pagehead bg-gray-light pb-0 pt-3 mb-4">
      <div class="px-0">
        <div class="mb-3 d-flex px-3 px-md-3 px-lg-5">
          <div class="flex-auto min-width-0 width-fit mr-3">
            <div class="d-flex">
              <div class="d-none d-md-block">
                <a class="avatar mr-2 flex-shrink-0" href="https://xwlu.github.io/">
                  <img class=" avatar-user"
                    src="/images/avatar.png"
                    width="32" height="32"></a>
              </div>
              <div class="d-flex flex-column">
                <h1 class="break-word f3 text-normal mb-md-0 mb-1">
                  <span class="author">
                    <a href="https://xwlu.github.io/">looyifan</a>
                  </span>
                  <span class="path-divider">/</span>
                  <strong class="css-truncate css-truncate-target mr-1" style="max-width: 410px">
                    <a href="https://xwlu.github.io/post/languages/c&#43;&#43;/exception/">Exception</a>
                  </strong>
                </h1>
                <div class="note m-0">
                  Created <relative-time datetime="Wed, 02 Apr 2025 10:32:39 &#43;0800"
                    class="no-wrap">
                    Wed, 02 Apr 2025 10:32:39 &#43;0800</relative-time>

                  
                  <span class="file-info-divider"></span>
                  Modified <relative-time datetime="Thu, 03 Apr 2025 17:11:44 &#43;0800"
                    class="no-wrap">
                    Thu, 03 Apr 2025 17:11:44 &#43;0800</relative-time>
                  
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container-lg px-3 new-discussion-timeline">
      <div class="repository-content gist-content">
        <div>
          <div class="js-gist-file-update-container js-task-list-container file-box">
            <div id="file-pytest" class="file my-2">
              <div id="post-header" class="file-header d-flex flex-md-items-center flex-items-start sticky-header" style="z-index: 2">
                <div class="file-info d-flex flex-md-items-center flex-items-start flex-order-1 flex-auto">
                  <div class="text-mono f6 flex-auto pr-3 flex-order-2 flex-md-order-1 mt-2 mt-md-0">
                    
                    <summary id="toc-toggle" onclick="clickToc()" class="btn btn-octicon m-0 mr-2 p-2">
                      <svg aria-hidden="true" viewBox="0 0 16 16" height="16" width="16" class="octicon octicon-list-unordered">
                        <path fill-rule="evenodd" d="M2 4a1 1 0 100-2 1 1 0 000 2zm3.75-1.5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zm0 5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zm0 5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zM3 8a1 1 0 11-2 0 1 1 0 012 0zm-1 6a1 1 0 100-2 1 1 0 000 2z"></path>
                      </svg>
                    </summary>
                    <details-menu class="SelectMenu" id="toc-details" style="display: none;">
                      <div class="SelectMenu-modal rounded-3 mt-1" style="max-height: 340px;">
                        <div class="SelectMenu-list SelectMenu-list--borderless p-2" style="overscroll-behavior: contain;" id="toc-list">
                        </div>
                      </div>
                    </details-menu>
                      2283 Words
                    

                  </div>
                  <div class="file-actions flex-order-2 pt-0">
                    
                  </div>
                </div>
              </div>


              <div class="Box-body px-5 pb-5" style="z-index: 1">
                <article class="markdown-body entry-content container-lg"><h1 id="基础">基础</h1>
<ul>
<li>通过关键字try/catch/throw引入异常处理机制
<pre tabindex="0"><code>void f1() {
  int x;
  double y;  // y先被销毁，x后被销毁
  throw 1;  // 此处抛出异常
  std::cout &lt;&lt; &#34;1&#34; &lt;&lt; std::endl;
}

int f2() {
  int x;
  double y;  // f1函数中的局部对象被销毁后，开始销毁f2中的局部对象
  try {
    f1();
  } catch(double) {
    // f1抛出的异常不会在这里被捕获，int和double类型不匹配
    std::cout &lt;&lt; &#34;exception catched 2: &#34; &lt;&lt; e &lt;&lt; std::endl; 
  }
  std::cout &lt;&lt; &#34;other logic in f2&#34; &lt;&lt; std::endl;  // 不会执行
}

int f3() {
  try {
    f2();
  } catch(int e) {
    std::cout &lt;&lt; &#34;exception catched 3: &#34; &lt;&lt; e &lt;&lt; std::endl;
  }
  std::cout &lt;&lt; &#34;other logic in f3&#34; &lt;&lt; std::endl;  // 会执行
}

int main() {
  try {
    f3();
  } catch(int) {  // 异常已经被处理了，这里不会捕获到异常
    std::cout &lt;&lt; &#34;exception catched 2!&#34; &lt;&lt; std::endl; 
  } catch(double) {
    // ...
  }
}
</code></pre></li>
<li>异常触发时的系统行为——栈展开
<ul>
<li>上面代码中的f1抛出异常后，会一层一层往上一个栈帧找catch匹配代码，找不到就抛弃对应栈帧</li>
<li>抛出异常后续的代码不会被执行</li>
<li>局部对象会按照构造相反的顺序自动销毁</li>
<li>系统尝试匹配相应的catch代码段
<ul>
<li>如果匹配则执行其中的逻辑，之后执行catch后续的代码</li>
<li>如果不匹配则继续进行栈展开，直到“跳出”main函数，触发terminate结束运行</li>
</ul>
</li>
</ul>
</li>
<li>异常对象
<ul>
<li>系统会使用抛出的异常拷贝初始化一个临时对象，称为异常对象</li>
<li>异常对象会在栈展开过程中被保留，并最终传递给匹配的catch语句</li>
</ul>
</li>
</ul>
<hr>
<h1 id="trycatch语句块">try/catch语句块</h1>
<ul>
<li>一个try语句块后面可以跟一个到多个catch语句块
<pre tabindex="0"><code>try {
  f3();
} catch(int) {
  // ...
} catch(double) {
  // ...
}
</code></pre></li>
<li>每个catch语句块用于匹配一种类型的异常对象</li>
<li>catch语句块的匹配按照从上到下进行
<pre tabindex="0"><code>// demo 1
void f0() {
  throw 1;
}

void f1() {
  try {
    f0();
  } catch(double) {
    std::cout &lt;&lt; &#34;double&#34; &lt;&lt; std::endl;
  } catch(int) {
    std::cout &lt;&lt; &#34;int&#34; &lt;&lt; std::endl;  // 会被该catch捕获
  }
}


// demo 2
struct Base {};
struct Derive : Base {};

void f2() {
  throw Derive{};  
}

void f3() {
  try {
    f2();
  } catch(Base&amp; e) {
    // 异常会被该catch捕获，系统会使用Derive尝试初始化Base类型的e，发现可以初始化，就被捕获了
    // 只有派生类-&gt;基类、数组-&gt;指针、函数-&gt;指针可以被匹配，int-&gt;double这种不行
    std::cout &lt;&lt; &#34;base&#34; &lt;&lt; std::endl;
  } catch(Derive&amp; e) {
    std::cout &lt;&lt; &#34;derive&#34; &lt;&lt; std::endl;
  }
}
</code></pre></li>
<li>使用catch(&hellip;)匹配任意异常，通常放在多个catch语句块的最后，兜底</li>
<li>可以在catch中调用throw抛出相同类型的异常
<pre tabindex="0"><code>void f0() {
  throw Str{};
}

void f1() {
  try {
    f0();
  } catch(...) {
    throw;  // 把捕获到的异常继续向下一层栈帧抛出
  }
}

int main() {
  try {
    f1();
  } catch(Str&amp; e) {
    // 捕获到最初由f0抛出的异常
  }
}
</code></pre></li>
</ul>
<hr>
<h1 id="一个异常未处理完成未被捕获时抛出新的异常会导致程序崩溃">一个异常未处理完成(未被捕获)时抛出新的异常会导致程序崩溃</h1>
<ul>
<li>不要在析构函数或者operator delete函数重载版本中抛出异常</li>
<li>通常来说，catch所接收的异常类型为引用类型
<ul>
<li>如果不加&amp;，就是用的拷贝初始化，而拷贝初始化过程可以抛出异常，所以存在程序崩溃风险</li>
</ul>
</li>
</ul>
<hr>
<h1 id="异常与构造析构函数">异常与构造&amp;析构函数</h1>
<ul>
<li>使用function-try-block来保护初始化逻辑
<pre tabindex="0"><code>struct Str {
  Str() { throw 100; }
};

class Cla {
public:
  Cla()
  try : mem() {  // 这里的&#34;: mem()&#34;可以删掉，编译器会隐式初始化mem，不需要用户显示指明
    // init logic
  } catch(int) {
    std::cout &lt;&lt; &#34;exception catched in Cla::Cla&#34; &lt;&lt; std::endl;
    // 编译器会在这里隐式地加一句&#34;throw;&#34;
  }
  int xxx;
private:
  Str mem;
};

int main() {
  try {
    Cla cla;
    cla.xxx;
  } catch(int) {
    // 下面这一行也会执行，因为C++规定，如果是在构造函数内捕获的异常，编译器会隐式地在catch语句块最后加上&#34;throw;&#34;命令
    // 这样做的原因是:
    // 如果不继续向外吐出捕获，程序就会执行到上面的&#34;cla.xxx;&#34;指令，由于cla的初始化并没有成功，执行这条指令的行为是未定义的。
    std::cout &lt;&lt; &#34;exception catched in main&#34; &lt;&lt; std::endl;
  }
}
</code></pre></li>
<li>function-try-block也支持一般函数
<pre tabindex="0"><code>void fun()
try {
  throw 123;  
} catch(...) {

}
</code></pre></li>
<li>在构造函数中抛出异常时，已经构造的成员会被销毁，但析构函数不会被调用
<ul>
<li>构造函数没执行完，有些变量还没初始化，直接调用析构函数就存在未定义行为了</li>
<li>对于已经构造出来的变量，如果需要手动清理的话，应该在构造函数的catch语句块中进行销毁处理</li>
</ul>
</li>
</ul>
<hr>
<h1 id="描述函数是否会抛出异常">描述函数是否会抛出异常</h1>
<ul>
<li>如果函数不会抛出异常，则应表明，为系统提供更多的优化空间
<ul>
<li>C++98的方式：
<ul>
<li>throw()：不会抛出异常</li>
<li>throw(int, char)：可能会抛出异常</li>
</ul>
</li>
<li>C++11后的改进：
<ul>
<li>noexcept：不会抛出异常</li>
<li>noexcept(false)：可能会抛出异常</li>
</ul>
</li>
</ul>
</li>
<li>noexcept
<ul>
<li>限定符：接受false/true表示是否会抛出异常</li>
<li>操作符：接受一个表达式，根据表达式是否可能抛出异常返回false/true
<pre tabindex="0"><code>void fun() noexcept(false) {}
void fun1() noexcept(noexcept(fun())) {
  fun();
}
int main() {
  std::cout &lt;&lt; noexcept(fun()) &lt;&lt; std::endl;  // 0
}
</code></pre></li>
<li>在声明了noexcept的函数中抛出异常会导致terminate被调用，程序终止，这里的异常无法在外部被捕获</li>
<li>不作为函数重载依据，但函数指针、虚拟函数重写时要保持形式兼容
<pre tabindex="0"><code>void fun() {}
int main() {
  void (*ptr)() noexcept = fun;  // 报错，fun可能会抛出异常，这里的函数指针明确了不能抛出异常，冲突了
  (*ptr)();
}
</code></pre></li>
</ul>
</li>
</ul>
<h1 id="标准异常">标准异常</h1>
<h2 id="异常类型">异常类型</h2>
<ul>
<li><img src="/images/languages/C++/std-exception.png" alt="std-exception"></li>
<li>exception:异常
<ul>
<li>runtime_error: 运行期异常
<ul>
<li>overflow_error</li>
<li>underflow_error</li>
</ul>
</li>
<li>logic_error: 逻辑异常
<ul>
<li>invalid_argument</li>
<li>length_error</li>
<li>out_of_range</li>
</ul>
</li>
<li>bad_alloc</li>
<li>bad_cast</li>
<li>bad_type_id</li>
<li>bad_exception</li>
</ul>
</li>
</ul>
<h2 id="尽量使用c提供的标准异常">尽量使用C++提供的标准异常</h2>
<pre tabindex="0"><code>#include &lt;stdexcept&gt;
void fun() {
  // throw 123;
  throw std::runtime_error(&#34;Invalid Input!&#34;);
}

int main() {
  try {
    fun();
  } catch (const std::runtime_error&amp; e) {
    std::cout &lt;&lt; e.what() &lt;&lt; &#34;\n&#34;;  // what是exception（基类）的虚函数
  } catch (const std::bad_alloc&amp; e) {
    // 如果在这里捕获到异常，意味着发生了内存分配失败的问题 
  }
  // 之所以标准定义了这么多种类的异常，就是让你在写代码的时候一眼就可以看出来异常类型和对应的处理逻辑
  // 你也可以自己定义异常
}
</code></pre><h1 id="正确对待异常">正确对待异常</h1>
<ul>
<li>不要滥用：异常的成本非常高
<ul>
<li>异常是用于处理程序不应该发生的逻辑，正常的跳转不要用</li>
</ul>
</li>
<li>不要不用：对真正的异常场景，异常处理是相对高效、简洁的处理方式</li>
<li>编写异常安全的代码
<ul>
<li>不安全的例子
<pre tabindex="0"><code>void fun() {
  int* ptr = new int[3];
  throw std::runtime_error(&#34;Invalid Input!&#34;);  // 栈展开了，ptr被销毁，但指向的内存没有被释放，泄露了
  delete []ptr;
}
</code></pre></li>
<li>需要注意的点：
<ul>
<li>避免裸的资源分配（如上代码）
<ul>
<li>内存：使用智能指针</li>
<li>文件：使用C++提供的fstream</li>
</ul>
</li>
<li>接口设计
<ul>
<li>stack的pop只返回void，top返回的是内容，这样设计就是为了异常安全</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</article>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>
<script type="application/javascript" src='https://xwlu.github.io/js/toc.js'></script>
<link rel="stylesheet" href='https://xwlu.github.io/css/toc.css' />

  
<div id="gitalk-container" class="gitalk-container"></div>
<link rel="stylesheet" href='https://xwlu.github.io/css/gitalk.css'>
<script src='https://xwlu.github.io/js/gitalk.min.js'></script>
<script>
  const gitalk = new Gitalk({
    clientID: '',
    clientSecret: '',
    repo: '',
    owner: '',
    admin: [''],
    id: eval( null ), 
    distractionFreeMode: false 
  });
  (function() {
    gitalk.render('gitalk-container');
  })();
</script>

</div>

  <div class="footer container-xl width-full p-responsive">
  <div
    class="position-relative d-flex flex-row-reverse flex-lg-row flex-wrap flex-lg-nowrap flex-justify-center flex-lg-justify-between flex-sm-items-center pt-6 pb-2 mt-6 f6 text-gray border-top border-gray-light ">
    <a aria-label="Homepage" title="GitHub" class="footer-octicon d-none d-lg-block mr-lg-4" href="https://xwlu.github.io/">
      <svg height="24" class="octicon octicon-mark-github" viewBox="0 0 16 16" version="1.1" width="24">
        <path fill-rule="evenodd"
          d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
        </path>
      </svg>
    </a>
    <ul class="list-style-none d-flex flex-wrap col-12 flex-justify-center flex-lg-justify-between mb-2 mb-lg-0">
      
      <li class="mr-3 mr-lg-0">Theme by <a href='https://github.com/MeiK2333/github-style'>github-style</a></li>
      
      <li class="mr-3 mr-lg-0">GitHub and the Invertocat logo are trademarks of <a href="https://github.com/">GitHub, Inc.</a></li>
    </ul>
  </div>
  <div class="d-flex flex-justify-center pb-6">
    <span class="f6 text-gray-light"></span>
  </div>


</div>

</body>

<script type="application/javascript" src="https://xwlu.github.io/js/github-style.js"></script>







</html>